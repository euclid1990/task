"use strict";var app=angular.module("lovefieldApp",["ngRoute","smart-table","datePicker","ngAudio","ui-notification","angular-web-notification","appControllers","appServices"]);app.config(["$routeProvider",function(e){e.when("/",{templateUrl:"/task/partials/home.html",controller:"appCtrl"}).otherwise({redirectTo:"/"})}]);var appControllers=angular.module("appControllers",[]);appControllers.controller("appCtrl",["$scope","$interval","$timeout","$window","webNotification","ngAudio","appSv","Notification",function(e,n,t,o,i,a,c,r){var l={name:"",description:"",deadline:"",done:0};e.init=function(){e.rowCollection=[],c.openConnection(),c.buildSchema(),c.fetchAll().then(function(n){e.$apply(function(){e.rowCollection=n}),s()}),e.task=angular.copy(l),o.notify.requestPermission(),e.sound=a.load("/task/sound/notification.mp3")},e.create=function(n){return n.name.length&&n.description.length?n.deadline?void c.addTask(n,function(){r("★ Create completed ★"),c.fetchAll().then(function(n){e.$apply(function(){e.rowCollection=n,e.reset()}),t(s,1e3)})}):r.error("Plz input valid deadline !"):r.error("Plz input name & description !")},e.reset=function(n){n&&(n.$setPristine(),n.$setUntouched()),e.task=angular.copy(l)},e.remove=function(n){c.deleteTask(n,function(){r("★ Task:"+n+" is removed ★"),c.fetchAll().then(function(n){e.$apply(function(){e.rowCollection=n,e.reset()})})})},e.resolve=function(n){c.doneTask(n,function(){r("★ Task:"+n+" is resolved ★"),c.fetchAll().then(function(n){e.$apply(function(){e.rowCollection=n,e.reset()})})})};var d=function(e,n){i.showNotification(e,{body:n,icon:"/task/img/notification-icon.png",autoClose:4e3},function(e,n){e?window.alert("Unable to show notification: "+e.message):setTimeout(function(){n()},5e3)})},u=new Date,f=!1,s=function(){f||(f=!0,u=new Date,u=new Date(u.getFullYear(),u.getMonth(),u.getDate(),u.getHours(),u.getMinutes()),c.fetchNewTask(u).then(function(n){n.forEach(function(e){d(e.name,e.description)}),n.length?(e.sound.play(),c.updateNewTask(u).then(function(){f=!1,c.fetchAll().then(function(n){e.$apply(function(){e.rowCollection=n})})})):f=!1}))};n(s,5e3);var p=function(){e.clock=Date.now()};p(),n(p,1e3)}]);var appServices=angular.module("appServices",[]);appServices.factory("appSv",function(){var e={};return e.schemaBuilder=null,e.openConnection=function(){e.schemaBuilder=lf.schema.create("lovefield",1)},e.buildSchema=function(){var n=e.schemaBuilder;n.createTable("Item").addColumn("id",lf.Type.INTEGER).addColumn("name",lf.Type.STRING).addColumn("description",lf.Type.STRING).addColumn("deadline",lf.Type.DATE_TIME).addColumn("done",lf.Type.BOOLEAN).addColumn("notified",lf.Type.BOOLEAN).addPrimaryKey(["id"],!0).addIndex("idxDeadline",["deadline"],!1,lf.Order.DESC)},e.addTask=function(n,t){var o,i,a=e.schemaBuilder;a.connect().then(function(e){o=e,i=e.getSchema().table("Item");var t=i.createRow({name:n.name,description:n.description,deadline:new Date(n.deadline),done:0===parseInt(n.done)?!1:!0,notified:!1});return e.insertOrReplace().into(i).values([t]).exec()}).then(function(){t()})},e.fetchAll=function(){var n,t=e.schemaBuilder;return t.connect().then(function(e){return n=e.getSchema().table("Item"),e.select().from(n).orderBy(n.id,lf.Order.DESC).exec()})},e.deleteTask=function(n,t){var o,i=e.schemaBuilder;i.connect().then(function(e){return o=e.getSchema().table("Item"),e["delete"]().from(o).where(o.id.eq(n)).exec()}).then(function(){t()})},e.doneTask=function(n,t){var o,i=e.schemaBuilder;i.connect().then(function(e){return o=e.getSchema().table("Item"),e.update(o).set(o.done,!0).set(o.notified,!0).where(o.id.eq(n)).exec()}).then(function(){t()})},e.fetchNewTask=function(n){var t,o=e.schemaBuilder;return o.connect().then(function(e){return t=e.getSchema().table("Item"),e.select().from(t).where(lf.op.and(t.done.eq(!1),t.deadline.eq(n),t.notified.eq(!1))).exec()})},e.updateNewTask=function(n){var t,o=e.schemaBuilder;return o.connect().then(function(e){return t=e.getSchema().table("Item"),console.log(n),e.update(t).set(t.notified,1).where(lf.op.and(t.done.eq(!1),t.deadline.eq(n),t.notified.eq(!1))).exec()})},e});